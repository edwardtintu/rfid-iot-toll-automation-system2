<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTMS - Trust Visualization Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            color: #2c3e50;
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        header {
            background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%);
            color: white;
            padding: 25px 0;
            text-align: center;
            margin-bottom: 25px;
            border-radius: 12px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.15);
        }

        h1 {
            font-size: 2.8rem;
            margin-bottom: 8px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .subtitle {
            font-size: 1.3rem;
            opacity: 0.9;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.08);
            border: 1px solid #eef2f7;
        }

        .chart-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: #2c3e50;
            text-align: center;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .summary-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            text-align: center;
            border: 1px solid #eef2f7;
        }

        .summary-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 10px 0;
        }

        .summary-label {
            font-size: 1rem;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .trusted { color: #27ae60; }
        .degraded { color: #f39c12; }
        .suspended { color: #e74c3c; }
        .total { color: #3498db; }

        .controls {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.08);
            margin-bottom: 25px;
            border: 1px solid #eef2f7;
        }

        .control-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        label {
            font-weight: 600;
            color: #2c3e50;
        }

        select, input, button {
            padding: 10px 15px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 14px;
        }

        button {
            background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(52, 152, 219, 0.3);
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .tab {
            padding: 15px 25px;
            cursor: pointer;
            background: #f8f9fa;
            border: none;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s ease;
            flex: 1;
            text-align: center;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab.active {
            background: #3498db;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .control-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            h1 {
                font-size: 2.2rem;
            }
            
            .subtitle {
                font-size: 1.1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìä HTMS Trust Visualization Dashboard</h1>
            <div class="subtitle">Real-time visualization of reader trust scores and decision telemetry</div>
        </header>

        <div class="controls">
            <div class="control-group">
                <label for="timeRange">Time Range:</label>
                <select id="timeRange">
                    <option value="1h">Last Hour</option>
                    <option value="6h">Last 6 Hours</option>
                    <option value="24h" selected>Last 24 Hours</option>
                    <option value="7d">Last 7 Days</option>
                    <option value="30d">Last 30 Days</option>
                </select>
                
                <label for="readerFilter">Filter by Reader:</label>
                <select id="readerFilter">
                    <option value="all" selected>All Readers</option>
                    <option value="TOLL_READER_01">TOLL_READER_01</option>
                    <option value="TOLL_READER_02">TOLL_READER_02</option>
                    <option value="TOLL_READER_03">TOLL_READER_03</option>
                </select>
                
                <button onclick="refreshCharts()">üîÑ Refresh Data</button>
                <button onclick="goToDashboard()">üè† Back to Dashboard</button>
            </div>
        </div>

        <div class="summary-cards">
            <div class="summary-card">
                <div class="summary-label">Total Readers</div>
                <div class="summary-value total" id="total-readers">0</div>
            </div>
            <div class="summary-card">
                <div class="summary-label">Trusted Readers</div>
                <div class="summary-value trusted" id="trusted-readers">0</div>
            </div>
            <div class="summary-card">
                <div class="summary-label">Degraded Readers</div>
                <div class="summary-value degraded" id="degraded-readers">0</div>
            </div>
            <div class="summary-card">
                <div class="summary-label">Suspended Readers</div>
                <div class="summary-value suspended" id="suspended-readers">0</div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('trust')">Trust Scores</button>
            <button class="tab" onclick="switchTab('decisions')">Decisions</button>
            <button class="tab" onclick="switchTab('analytics')">Analytics</button>
            <button class="tab" onclick="switchTab('violations')">Violations</button>
        </div>

        <div id="trust-tab" class="tab-content active">
            <div class="dashboard-grid">
                <div class="chart-container">
                    <div class="chart-title">Reader Trust Scores Over Time</div>
                    <canvas id="trustScoresChart"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Trust Distribution</div>
                    <canvas id="trustDistributionChart"></canvas>
                </div>
            </div>
        </div>

        <div id="decisions-tab" class="tab-content">
            <div class="dashboard-grid">
                <div class="chart-container">
                    <div class="chart-title">Decisions by Reader</div>
                    <canvas id="decisionsByReaderChart"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Decision Trends</div>
                    <canvas id="decisionTrendsChart"></canvas>
                </div>
            </div>
        </div>

        <div id="analytics-tab" class="tab-content">
            <div class="dashboard-grid">
                <div class="chart-container">
                    <div class="chart-title">Trust Alerts</div>
                    <canvas id="trustAlertsChart"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Anomaly Detection</div>
                    <canvas id="anomalyChart"></canvas>
                </div>
            </div>
        </div>

        <div id="violations-tab" class="tab-content">
            <div class="dashboard-grid">
                <div class="chart-container">
                    <div class="chart-title">Violations by Type</div>
                    <canvas id="violationsByTypeChart"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Recent Violations</div>
                    <div class="chart-title" style="text-align: left; font-size: 1rem;">
                        <table id="violationsTable" style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="padding: 10px; text-align: left;">Reader ID</th>
                                    <th style="padding: 10px; text-align: left;">Violation</th>
                                    <th style="padding: 10px; text-align: left;">Time</th>
                                    <th style="padding: 10px; text-align: left;">Impact</th>
                                </tr>
                            </thead>
                            <tbody id="violations-tbody">
                                <tr><td colspan="4" style="padding: 15px; text-align: center;">Loading violations...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = "http://127.0.0.1:8000";
        
        // Chart instances
        let trustScoresChart, trustDistributionChart, decisionsByReaderChart, 
            decisionTrendsChart, trustAlertsChart, anomalyChart, violationsByTypeChart;
        
        // Initialize the dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initCharts();
            loadData();
            
            // Refresh data every 30 seconds
            setInterval(loadData, 30000);
        });
        
        function initCharts() {
            // Trust Scores Chart
            const trustCtx = document.getElementById('trustScoresChart').getContext('2d');
            trustScoresChart = new Chart(trustCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'TOLL_READER_01',
                        data: [],
                        borderColor: '#36a2eb',
                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'TOLL_READER_02',
                        data: [],
                        borderColor: '#ff6384',
                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'TOLL_READER_03',
                        data: [],
                        borderColor: '#4bc0c0',
                        backgroundColor: 'rgba(75, 192, 192, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Trust Scores Over Time'
                        }
                    },
                    scales: {
                        y: {
                            min: 0,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Trust Score'
                            }
                        }
                    }
                }
            });
            
            // Trust Distribution Chart
            const distCtx = document.getElementById('trustDistributionChart').getContext('2d');
            trustDistributionChart = new Chart(distCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Trusted', 'Degraded', 'Suspended'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: ['#2ecc71', '#f39c12', '#e74c3c']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Trust Status Distribution'
                        }
                    }
                }
            });
            
            // Decisions by Reader Chart
            const decisionsCtx = document.getElementById('decisionsByReaderChart').getContext('2d');
            decisionsByReaderChart = new Chart(decisionsCtx, {
                type: 'bar',
                data: {
                    labels: ['TOLL_READER_01', 'TOLL_READER_02', 'TOLL_READER_03'],
                    datasets: [{
                        label: 'Allowed',
                        data: [0, 0, 0],
                        backgroundColor: '#2ecc71'
                    }, {
                        label: 'Blocked',
                        data: [0, 0, 0],
                        backgroundColor: '#e74c3c'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Decisions by Reader'
                        }
                    },
                    scales: {
                        x: {
                            stacked: true,
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true
                        }
                    }
                }
            });
            
            // Decision Trends Chart
            const trendsCtx = document.getElementById('decisionTrendsChart').getContext('2d');
            decisionTrendsChart = new Chart(trendsCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Allowed',
                        data: [],
                        borderColor: '#2ecc71',
                        backgroundColor: 'rgba(46, 204, 113, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Blocked',
                        data: [],
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Decision Trends Over Time'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Decisions'
                            }
                        }
                    }
                }
            });
            
            // Trust Alerts Chart
            const alertsCtx = document.getElementById('trustAlertsChart').getContext('2d');
            trustAlertsChart = new Chart(alertsCtx, {
                type: 'bar',
                data: {
                    labels: ['Critical', 'High', 'Medium', 'Low'],
                    datasets: [{
                        label: 'Trust Alerts',
                        data: [0, 0, 0, 0],
                        backgroundColor: ['#e74c3c', '#f39c12', '#f1c40f', '#2ecc71']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Trust Alert Levels'
                        }
                    }
                }
            });
            
            // Anomaly Detection Chart
            const anomalyCtx = document.getElementById('anomalyChart').getContext('2d');
            anomalyChart = new Chart(anomalyCtx, {
                type: 'bar',
                data: {
                    labels: ['Spatial', 'Temporal', 'Behavioral', 'Cross-Reader'],
                    datasets: [{
                        label: 'Anomalies Detected',
                        data: [0, 0, 0, 0],
                        backgroundColor: ['#9b59b6', '#3498db', '#1abc9c', '#e67e22']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Anomaly Types Detected'
                        }
                    }
                }
            });
            
            // Violations by Type Chart
            const violationsCtx = document.getElementById('violationsByTypeChart').getContext('2d');
            violationsByTypeChart = new Chart(violationsCtx, {
                type: 'pie',
                data: {
                    labels: ['Replay Attack', 'Auth Failure', 'Rate Limit', 'Other'],
                    datasets: [{
                        data: [0, 0, 0, 0],
                        backgroundColor: ['#e74c3c', '#f39c12', '#3498db', '#95a5a6']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Violations by Type'
                        }
                    }
                }
            });
        }
        
        async function loadData() {
            try {
                // Load trust analytics
                const analyticsResponse = await fetch(`${API_BASE}/api/trust/analytics`);
                const analyticsData = await analyticsResponse.json();
                
                if (analyticsResponse.ok) {
                    document.getElementById('total-readers').textContent = analyticsData.overall_statistics.total_readers;
                    document.getElementById('trusted-readers').textContent = analyticsData.overall_statistics.trusted_readers;
                    document.getElementById('degraded-readers').textContent = analyticsData.overall_statistics.degraded_readers;
                    document.getElementById('suspended-readers').textContent = analyticsData.overall_statistics.suspended_readers;
                    
                    // Update trust distribution chart
                    trustDistributionChart.data.datasets[0].data = [
                        analyticsData.overall_statistics.trusted_readers,
                        analyticsData.overall_statistics.degraded_readers,
                        analyticsData.overall_statistics.suspended_readers
                    ];
                    trustDistributionChart.update();
                }
                
                // Load trust alerts
                const alertsResponse = await fetch(`${API_BASE}/api/trust/alerts`);
                const alertsData = await alertsResponse.json();
                
                if (alertsResponse.ok) {
                    // For demo purposes, generate sample alert data
                    trustAlertsChart.data.datasets[0].data = [2, 5, 8, 12]; // Critical, High, Medium, Low
                    trustAlertsChart.update();
                }
                
                // Load sample trust scores over time
                const timeLabels = [];
                const reader1Data = [];
                const reader2Data = [];
                const reader3Data = [];
                
                // Generate sample data for the last 12 hours
                for (let i = 12; i >= 0; i--) {
                    const time = new Date();
                    time.setHours(time.getHours() - i);
                    timeLabels.push(time.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}));
                    
                    // Generate somewhat realistic trust scores with some variation
                    reader1Data.push(Math.min(100, Math.max(40, 90 - Math.random() * 20 - (i * 0.5))));
                    reader2Data.push(Math.min(100, Math.max(40, 85 - Math.random() * 25 - (i * 0.3))));
                    reader3Data.push(Math.min(100, Math.max(40, 95 - Math.random() * 15 - (i * 0.7))));
                }
                
                trustScoresChart.data.labels = timeLabels;
                trustScoresChart.data.datasets[0].data = reader1Data;
                trustScoresChart.data.datasets[1].data = reader2Data;
                trustScoresChart.data.datasets[2].data = reader3Data;
                trustScoresChart.update();
                
                // Load sample decision data
                const decisionLabels = [];
                const allowedData = [];
                const blockedData = [];
                
                for (let i = 12; i >= 0; i--) {
                    const time = new Date();
                    time.setHours(time.getHours() - i);
                    decisionLabels.push(time.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}));
                    
                    // Generate sample decision data
                    allowedData.push(Math.floor(Math.random() * 50) + 10);
                    blockedData.push(Math.floor(Math.random() * 20) + 5);
                }
                
                decisionTrendsChart.data.labels = decisionLabels;
                decisionTrendsChart.data.datasets[0].data = allowedData;
                decisionTrendsChart.data.datasets[1].data = blockedData;
                decisionTrendsChart.update();
                
                // Update decisions by reader chart
                decisionsByReaderChart.data.datasets[0].data = [
                    Math.floor(Math.random() * 100) + 50,
                    Math.floor(Math.random() * 80) + 40,
                    Math.floor(Math.random() * 120) + 60
                ];
                decisionsByReaderChart.data.datasets[1].data = [
                    Math.floor(Math.random() * 30) + 10,
                    Math.floor(Math.random() * 25) + 8,
                    Math.floor(Math.random() * 35) + 12
                ];
                decisionsByReaderChart.update();
                
                // Update anomaly chart
                anomalyChart.data.datasets[0].data = [
                    Math.floor(Math.random() * 10),
                    Math.floor(Math.random() * 8),
                    Math.floor(Math.random() * 12),
                    Math.floor(Math.random() * 5)
                ];
                anomalyChart.update();
                
                // Update violations by type chart
                violationsByTypeChart.data.datasets[0].data = [
                    Math.floor(Math.random() * 15),
                    Math.floor(Math.random() * 10),
                    Math.floor(Math.random() * 8),
                    Math.floor(Math.random() * 5)
                ];
                violationsByTypeChart.update();
                
                // Load sample violations data
                const violationsBody = document.getElementById('violations-tbody');
                violationsBody.innerHTML = '';
                
                // Generate sample violations
                const sampleViolations = [
                    { reader: 'TOLL_READER_01', type: 'Replay Attack', time: '2023-05-15 14:30:22', impact: '-15' },
                    { reader: 'TOLL_READER_02', type: 'Auth Failure', time: '2023-05-15 14:25:18', impact: '-40' },
                    { reader: 'TOLL_READER_03', type: 'Rate Limit', time: '2023-05-15 14:20:05', impact: '-10' },
                    { reader: 'TOLL_READER_01', type: 'Peer Outlier', time: '2023-05-15 14:15:42', impact: '-12' },
                    { reader: 'TOLL_READER_02', type: 'Invalid Card', time: '2023-05-15 14:10:33', impact: '-5' }
                ];
                
                sampleViolations.forEach(violation => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td style="padding: 10px; border-bottom: 1px solid #eee;">${violation.reader}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #eee;">${violation.type}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #eee;">${violation.time}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #eee; color: #e74c3c; font-weight: bold;">${violation.impact}</td>
                    `;
                    violationsBody.appendChild(row);
                });
                
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }
        
        function refreshCharts() {
            loadData();
        }
        
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // Activate selected tab button
            event.target.classList.add('active');
        }
        
        function goToDashboard() {
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>