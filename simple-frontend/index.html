<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTMS - Hybrid Toll Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            color: #2c3e50;
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%);
            color: white;
            padding: 25px 0;
            text-align: center;
            margin-bottom: 25px;
            border-radius: 12px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.15);
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="0.5"/></svg>');
            opacity: 0.2;
        }

        h1 {
            font-size: 2.8rem;
            margin-bottom: 8px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
            position: relative;
            z-index: 1;
        }

        .subtitle {
            font-size: 1.3rem;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .system-overview {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 25px;
        }

        .status-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            text-align: center;
            border: 1px solid #eef2f7;
        }

        .status-card h3 {
            font-size: 1.4rem;
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .status-card p {
            font-size: 0.9rem;
            color: #6c757d;
        }

        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            border: 1px solid #eef2f7;
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #3498db, #2ecc71, #f39c12, #e74c3c);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(0,0,0,0.15);
        }

        .card h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.6rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #dee2e6;
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: scale(1.03);
        }

        .stat-number {
            font-size: 2.2rem;
            font-weight: bold;
            color: #3498db;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 1rem;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 1rem;
        }

        input, select, button {
            width: 100%;
            padding: 14px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        button {
            background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 6px 15px rgba(0,0,0,0.08);
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        th {
            background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.9rem;
        }

        .allow {
            color: #27ae60;
            font-weight: bold;
            background-color: #e8f5e9;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .block {
            color: #c0392b;
            font-weight: bold;
            background-color: #ffebee;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .transaction-table {
            max-height: 450px;
            overflow-y: auto;
            border-radius: 10px;
        }

        .tabs {
            display: flex;
            margin-bottom: 25px;
            border-bottom: 2px solid #e1e8ed;
            overflow-x: auto;
            padding-bottom: 5px;
        }

        .tab {
            padding: 14px 28px;
            cursor: pointer;
            background: #f8f9fa;
            border: 1px solid #e1e8ed;
            border-bottom: none;
            margin-right: 8px;
            border-radius: 8px 8px 0 0;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .tab:hover {
            background: #e9ecef;
            color: #495057;
        }

        .tab.active {
            background: white;
            color: #3498db;
            font-weight: bold;
            border-bottom: 2px solid #3498db;
            margin-bottom: -2px;
            box-shadow: 0 -2px 8px -2px rgba(52, 152, 219, 0.1);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .ml-scores {
            font-size: 0.9rem;
            color: #6c757d;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
        }

        .loading {
            text-align: center;
            padding: 30px;
            color: #6c757d;
            font-size: 1.1rem;
        }

        .error {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 5px solid #e74c3c;
        }

        .success {
            background: linear-gradient(135deg, #51cf66 0%, #40c057 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 5px solid #2ecc71;
        }

        .flex {
            display: flex;
            gap: 15px;
        }

        .flex-1 {
            flex: 1;
        }

        footer {
            text-align: center;
            margin-top: 50px;
            padding: 30px;
            color: #6c757d;
            border-top: 1px solid #e1e8ed;
            background: white;
            border-radius: 10px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }

        /* Security Flow Timeline Styles */
        .security-step {
            margin-bottom: 15px;
            padding: 15px;
            border-left: 4px solid #e9ecef;
            background: #f8f9fa;
            border-radius: 0 8px 8px 0;
            transition: all 0.3s ease;
        }

        .security-step:hover {
            background: #edf2f7;
            border-left-color: #3498db;
        }

        .step-header {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .step-icon {
            font-size: 1.4em;
            margin-right: 12px;
            width: 28px;
        }

        .step-details {
            font-size: 0.95em;
            color: #6c757d;
            margin-left: 40px;
            line-height: 1.5;
        }

        .status-pass {
            color: #27ae60;
        }

        .status-fail {
            color: #e74c3c;
        }

        .status-pending {
            color: #f39c12;
        }

        /* Security Attack Card Styles */
        .security-attack-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border: 1px solid #eef2f7;
        }

        /* System Status Bar Styles */
        #system-status {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #dee2e6;
        }

        @media (max-width: 768px) {
            .system-overview {
                grid-template-columns: 1fr;
            }

            .main-content {
                grid-template-columns: 1fr;
            }

            .flex {
                flex-direction: column;
            }

            .tabs {
                flex-wrap: wrap;
            }

            .tab {
                margin-bottom: 5px;
            }

            h1 {
                font-size: 2.2rem;
            }

            .subtitle {
                font-size: 1.1rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Responsive adjustments */
        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }

            .card {
                padding: 20px;
            }

            .tabs {
                flex-direction: column;
            }

            .tab {
                border-radius: 8px;
                margin-right: 0;
                margin-bottom: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>HTMS - Hybrid Toll Management System</h1>
            <div class="subtitle">Secure Reader-Authenticated Toll Operations & Audit Dashboard</div>
        </header>

        <!-- Navigation Tabs -->
        <div class="tabs">
            <div class="tab active" onclick="switchToDashboard()">Dashboard</div>
            <div class="tab" onclick="switchToProcess()">Process Toll</div>
            <div class="tab" onclick="switchToLookup()">Card Lookup</div>
            <div class="tab" onclick="switchToHistory()">History</div>
            <div class="tab" onclick="switchToBlockchain()">Blockchain</div>
            <div class="tab" onclick="switchToComparison()">‚≠ê Novelty & Comparison</div>
            <div class="tab" onclick="switchToSecurity()">üõ°Ô∏è Security Demonstration</div>
            <div class="tab" onclick="switchToPrivacy()">üîí Privacy & Data Protection</div>
            <div class="tab" onclick="openSimulationConsole()">üî¨ Simulation Console</div>
            <div class="tab" onclick="window.location.href='reader_trust.html'">üõ°Ô∏è Reader Trust Dashboard</div>
        </div>

        <!-- System Status Bar -->
        <div id="system-status" style="background: #e9ecef; padding: 15px; border-radius: 8px; margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center;">
            <div style="display: flex; gap: 20px;">
                <div>
                    <span style="color: #28a745;">üü¢</span>
                    <strong>Reader:</strong> ACTIVE
                </div>
                <div>
                    <span style="color: #28a745;">üü¢</span>
                    <strong>Backend:</strong> RUNNING
                </div>
                <div>
                    <span id="blockchain-status-indicator" style="color: #ffc107;">üü°</span>
                    <strong>Audit Ledger:</strong> <span id="blockchain-status-text">OFFLINE</span>
                </div>
            </div>
            <div>
                <strong>Buffered Events:</strong> <span id="buffered-count">0</span>
            </div>
        </div>

        <!-- Tab Content Containers -->
        <div id="dashboard" class="tab-content active">

        <div class="system-overview">
            <div class="status-card">
                <h3>üü¢ ACTIVE</h3>
                <p>Reader Status</p>
            </div>
            <div class="status-card">
                <h3>üü¢ RUNNING</h3>
                <p>Backend Status</p>
            </div>
            <div class="status-card">
                <h3>üü° OFFLINE</h3>
                <p>Audit Ledger</p>
            </div>
            <div class="status-card">
                <h3>3</h3>
                <p>Awaiting Sync</p>
            </div>
        </div>

        <div class="main-content">
            <div class="card">
                <h2>ÈÄöË°å Toll Operations Monitor</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="total-transactions">0</div>
                        <div class="stat-label">Total Transactions</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="allowed-count">0</div>
                        <div class="stat-label">Authorized</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="blocked-count">0</div>
                        <div class="stat-label">Rejected</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="revenue">‚Çπ0</div>
                        <div class="stat-label">Revenue</div>
                    </div>
                </div>

                <h3 style="margin-top: 20px;">Recent Toll Events</h3>
                <div class="transaction-table">
                    <table id="recent-transactions">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Reader</th>
                                <th>Vehicle ID</th>
                                <th>Decision</th>
                                <th>Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="5">Loading...</td>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>üõ°Ô∏è Security & Resilience</h2>
                
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="display: grid; grid-template-columns: 1fr; gap: 10px;">
                        <div style="text-align: center;">
                            <h3>üü° ACTIVE</h3>
                            <p>Resilience Mode</p>
                        </div>
                        <div style="text-align: center;">
                            <h3>3</h3>
                            <p>Buffered Events</p>
                        </div>
                    </div>
                </div>
                
                <button class="btn-secondary" onclick="syncPendingEvents()">Trigger Ledger Sync</button>

                <h3 style="margin-top: 20px;">Security Events</h3>
                <div id="security-events">
                    <p style="font-size: 0.9em; color: #6c757d;">‚Ä¢ Replay attempt blocked</p>
                    <p style="font-size: 0.9em; color: #6c757d;">‚Ä¢ Unauthorized reader rejected</p>
                    <p style="font-size: 0.9em; color: #6c757d;">‚Ä¢ Duplicate nonce detected</p>
                </div>

                <h3 style="margin-top: 20px;">Reader Trust Status</h3>
                <div id="reader-trust-info">
                    <div style="background: #f0f8ff; padding: 12px; border-radius: 8px; border-left: 4px solid #3498db;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>Reader ID:</strong> <span id="current-reader-id">TOLL_READER_01</span><br>
                                <strong>Trust Score:</strong> <span id="current-trust-score">100</span><br>
                                <strong>Trust Level:</strong> <span id="current-trust-status" style="color: #27ae60; font-weight: bold;">TRUSTED</span>
                            </div>
                            <div>
                                <button class="btn-secondary" onclick="refreshReaderTrust()" style="padding: 8px 12px; font-size: 0.9em;">Refresh</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>üîó Audit Ledger (Conditional Blockchain Logging)</h2>
            <p style="margin-bottom: 15px;">Only verified toll events are immutably recorded.</p>
            
            <div class="transaction-table">
                <table id="blockchain-table">
                    <thead>
                        <tr>
                            <th>Event ID</th>
                            <th>Hash</th>
                            <th>Reader</th>
                            <th>Time</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="blockchain-body">
                        <tr>
                            <td colspan="5">Loading blockchain data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <footer>
        <p>System View: Secure toll operations monitoring for academic and evaluation purposes.</p>
    </footer>

    <script>
        // API configuration
        const API_BASE = 'http://127.0.0.1:8000';

        // State management
        let transactions = [];
        let blockchainTransactions = [];
        let allCardDetails = new Map();

        // Load dashboard data
        function loadDashboard() {
            // For now, we'll simulate data since we can't access the backend
            simulateDashboardData();

            // Try to fetch real data from backend
            fetch(`${API_BASE}/api/card/5B88F75`)
                .then(response => response.json())
                .then(data => {
                    // Update dashboard stats based on actual data
                    console.log('Card data:', data);
                    // Update with real data
                    updateDashboardStats();
                })
                .catch(error => {
                    console.log('Backend not available, using simulated data');
                });
        }

        // Simulate dashboard data for demonstration
        function simulateDashboardData() {
            // Mock recent transactions
            transactions = [
                {
                    tagUID: '9C981B6',
                    vehicle_type: 'TRUCK',
                    amount: 400,
                    decision: 'block',
                    timestamp: new Date().toISOString(),
                    reason: 'High fraud probability (RF)',
                    ml_scores: { modelA_prob: 0.0, modelB_prob: 0.88, iso_flag: 0 },
                    tx_hash: '4991c993f3f87effecf0d9e503e731765aa662b1b8c2a3d11672c6e85a7cb65f',
                    new_balance: 1000.0
                },
                {
                    tagUID: '5B88F75',
                    vehicle_type: 'CAR',
                    amount: 120,
                    decision: 'allow',
                    timestamp: new Date(Date.now() - 60000).toISOString(),
                    reason: '',
                    ml_scores: { modelA_prob: 0.0, modelB_prob: 0.35, iso_flag: 0 },
                    tx_hash: '10785a8e161bf117c21d0c935c45c0f79d8298a009db65d45801c8b534e6589f',
                    new_balance: 20.0
                },
                {
                    tagUID: 'BE9E1E33',
                    vehicle_type: 'BUS',
                    amount: 250,
                    decision: 'allow',
                    timestamp: new Date(Date.now() - 120000).toISOString(),
                    reason: '',
                    ml_scores: { modelA_prob: 0.1, modelB_prob: 0.3, iso_flag: 0 },
                    tx_hash: '2a3b4c5d6e7f8g9h10i11j12k13l14m15n16o17p18q19r20s21t22u23v24w',
                    new_balance: 550.0
                }
            ];

            // Mock blockchain transactions
            blockchainTransactions = [
                {
                    transactionId: 0,
                    tagUID: '9C981B6',
                    vehicleType: 'TRUCK',
                    amount: 40000,
                    decision: 'block',
                    reason: 'High fraud probability (RF)',
                    timestamp: Math.floor(Date.now() / 1000) - 300,
                    txHash: '0x4991c993f3f87effecf0d9e503e731765aa662b1b8c2a3d11672c6e85a7cb65f',
                    registeredBy: '0x706C8a20338A3Faa7aB8262e4003A9a344a71d50'
                },
                {
                    transactionId: 1,
                    tagUID: '5B88F75',
                    vehicleType: 'CAR',
                    amount: 12000,
                    decision: 'allow',
                    reason: '',
                    timestamp: Math.floor(Date.now() / 1000) - 600,
                    txHash: '0x10785a8e161bf117c21d0c935c45c0f79d8298a009db65d45801c8b534e6589f',
                    registeredBy: '0x706C8a20338A3Faa7aB8262e4003A9a344a71d50'
                },
                {
                    transactionId: 2,
                    tagUID: 'BE9E1E33',
                    vehicleType: 'BUS',
                    amount: 25000,
                    decision: 'allow',
                    reason: '',
                    timestamp: Math.floor(Date.now() / 1000) - 900,
                    txHash: '0x2a3b4c5d6e7f8g9h10i11j12k13l14m15n16o17p18q19r20s21t22u23v24w',
                    registeredBy: '0x706C8a20338A3Faa7aB8262e4003A9a344a71d50'
                },
                {
                    transactionId: 3,
                    tagUID: '1A2B3C4',
                    vehicleType: 'CAR',
                    amount: 12000,
                    decision: 'block',
                    reason: 'Duplicate scan within 1 minute',
                    timestamp: Math.floor(Date.now() / 1000) - 1200,
                    txHash: '0x3b4c5d6e7f8g9h10i11j12k13l14m15n16o17p18q19r20s21t22u23v24w25x',
                    registeredBy: '0x706C8a20338A3Faa7aB8262e4003A9a344a71d50'
                },
                {
                    transactionId: 4,
                    tagUID: '5D6E7F8',
                    vehicleType: 'TRUCK',
                    amount: 40000,
                    decision: 'allow',
                    reason: '',
                    timestamp: Math.floor(Date.now() / 1000) - 1500,
                    txHash: '0x4c5d6e7f8g9h10i11j12k13l14m15n16o17p18q19r20s21t22u23v24w25x26y',
                    registeredBy: '0x706C8a20338A3Faa7aB8262e4003A9a344a71d50'
                }
            ];

            // Mock card details
            allCardDetails.set('9C981B6', {
                uid: '9C981B6',
                owner_name: 'Sundaramurthy',
                vehicle_number: 'TN45XY9876',
                vehicle_type: 'TRUCK',
                balance: 1000.0,
                tariff_amount: 400.0,
                last_seen: new Date(Date.now() - 300000).toISOString()
            });

            allCardDetails.set('5B88F75', {
                uid: '5B88F75',
                owner_name: 'Hariharan Sundaramoorthy',
                vehicle_number: 'TN23AB1234',
                vehicle_type: 'CAR',
                balance: 20.0,
                tariff_amount: 120.0,
                last_seen: new Date().toISOString()
            });

            updateDashboardStats();
            updateRecentTransactions();
            updateFraudStats();
        }

        // Update dashboard statistics
        function updateDashboardStats() {
            const allowed = transactions.filter(t => t.decision === 'allow').length;
            const blocked = transactions.filter(t => t.decision === 'block').length;
            const revenue = transactions
                .filter(t => t.decision === 'allow')
                .reduce((sum, t) => sum + t.amount, 0);

            document.getElementById('total-transactions').textContent = transactions.length;
            document.getElementById('allowed-count').textContent = allowed;
            document.getElementById('blocked-count').textContent = blocked;
            document.getElementById('revenue').textContent = `‚Çπ${revenue}`;
        }

        // Update recent transactions table
        function updateRecentTransactions() {
            const tbody = document.querySelector('#recent-transactions tbody');
            tbody.innerHTML = '';

            transactions.slice(0, 10).forEach(transaction => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${new Date(transaction.timestamp).toLocaleTimeString()}</td>
                    <td>TOLL_READER_01</td>
                    <td>${transaction.tagUID.substring(0, 3)}‚Ä¢‚Ä¢‚Ä¢${transaction.tagUID.substring(transaction.tagUID.length - 3)}</td>
                    <td class="${transaction.decision}">${transaction.decision.toUpperCase()}</td>
                    <td>‚Çπ${transaction.amount}</td>
                `;
            });
        }

        // Update fraud detection stats
        function updateFraudStats() {
            const fraudStatsDiv = document.getElementById('security-events');
            if (transactions.length > 0) {
                const latest = transactions[0];
                fraudStatsDiv.innerHTML = `
                    <p style="font-size: 0.9em; color: #6c757d;">‚Ä¢ Last event: ${latest.tagUID}</p>
                    <p style="font-size: 0.9em; color: #6c757d;">‚Ä¢ Decision: <span class="${latest.decision}">${latest.decision.toUpperCase()}</span></p>
                    ${latest.reason ? `<p style="font-size: 0.9em; color: #6c757d;">‚Ä¢ Reason: ${latest.reason}</p>` : ''}
                `;
            } else {
                fraudStatsDiv.innerHTML = '<p style="font-size: 0.9em; color: #6c757d;">No recent security events</p>';
            }
        }

        // Process toll transaction
        function processToll() {
            const uid = document.getElementById('process-uid').value.trim();
            const speed = parseInt(document.getElementById('process-speed').value) || 60;
            const resultDiv = document.getElementById('process-result');

            if (!uid) {
                resultDiv.innerHTML = '<div class="error">Please enter a UID</div>';
                return;
            }

            resultDiv.innerHTML = '<div class="loading">Processing...</div>';

            // Simulate API call to backend
            setTimeout(() => {
                // Simulate different outcomes based on UID
                let result;
                if (uid.toUpperCase() === '9C981B6') {
                    // TRUCK - likely to be blocked
                    result = {
                        tagUID: uid,
                        vehicle_type: 'TRUCK',
                        amount: 400,
                        decision: 'block',
                        timestamp: new Date().toISOString(),
                        reason: 'High fraud probability (RF)',
                        ml_scores: { modelA_prob: 0.0, modelB_prob: 0.88, iso_flag: 0 },
                        tx_hash: '4991c993f3f87effecf0d9e503e731765aa662b1b8c2a3d11672c6e85a7cb65f',
                        new_balance: 1000.0
                    };
                } else {
                    // CAR or other - likely to be allowed
                    result = {
                        tagUID: uid,
                        vehicle_type: 'CAR',
                        amount: 120,
                        decision: 'allow',
                        timestamp: new Date().toISOString(),
                        reason: '',
                        ml_scores: { modelA_prob: 0.0, modelB_prob: 0.35, iso_flag: 0 },
                        tx_hash: '10785a8e161bf117c21d0c935c45c0f79d8298a009db65d45801c8b534e6589f',
                        new_balance: 380.0
                    };
                }

                // Add to transactions list
                transactions.unshift(result);

                // Update dashboard
                updateDashboardStats();
                updateRecentTransactions();
                updateFraudStats();

                resultDiv.innerHTML = `
                    <div class="success">
                        <h3>Transaction Result: <span class="${result.decision}">${result.decision.toUpperCase()}</span></h3>
                        <p><strong>Vehicle ID:</strong> ${result.tagUID}</p>
                        <p><strong>Vehicle:</strong> ${result.vehicle_type}</p>
                        <p><strong>Amount:</strong> ‚Çπ${result.amount}</p>
                        <p><strong>Balance:</strong> ‚Çπ${result.new_balance}</p>
                        ${result.reason ? `<p><strong>Reason:</strong> ${result.reason}</p>` : ''}
                        ${result.ml_scores ? `
                        <div class="ml-scores">
                            <p><strong>Model A:</strong> ${(result.ml_scores.modelA_prob * 100).toFixed(1)}%</p>
                            <p><strong>Model B:</strong> ${(result.ml_scores.modelB_prob * 100).toFixed(1)}%</p>
                            <p><strong>Isolation:</strong> ${result.ml_scores.iso_flag ? 'Flagged' : 'Normal'}</p>
                        </div>
                        ` : ''}
                    </div>
                `;
            }, 1000);
        }

        // Lookup card details
        function lookupCard() {
            const uid = document.getElementById('lookup-uid').value.trim();
            const resultDiv = document.getElementById('lookup-result');

            if (!uid) {
                resultDiv.innerHTML = '<div class="error">Please enter a UID</div>';
                return;
            }

            resultDiv.innerHTML = '<div class="loading">Searching...</div>';

            // Simulate API call to backend
            setTimeout(() => {
                let cardDetails = allCardDetails.get(uid.toUpperCase());

                if (!cardDetails) {
                    // Simulate fetching from backend
                    cardDetails = {
                        uid: uid,
                        owner_name: 'Sample Owner',
                        vehicle_number: 'XXXXXX0001',
                        vehicle_type: 'CAR',
                        balance: 500.00,
                        tariff_amount: 120.00,
                        last_seen: new Date().toISOString()
                    };
                    allCardDetails.set(uid.toUpperCase(), cardDetails);
                }

                resultDiv.innerHTML = `
                    <div class="card" style="background: #f8f9fa; margin-top: 15px;">
                        <h3>Card Details: ${cardDetails.uid}</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 15px;">
                            <div><strong>Owner:</strong> ${cardDetails.owner_name}</div>
                            <div><strong>Vehicle:</strong> ${cardDetails.vehicle_number}</div>
                            <div><strong>Type:</strong> ${cardDetails.vehicle_type}</div>
                            <div><strong>Balance:</strong> ‚Çπ${cardDetails.balance.toFixed(2)}</div>
                            <div><strong>Tariff:</strong> ‚Çπ${cardDetails.tariff_amount.toFixed(2)}</div>
                            <div><strong>Last Seen:</strong> ${new Date(cardDetails.last_seen).toLocaleString()}</div>
                        </div>
                    </div>
                `;
            }, 800);
        }

        // Load transaction history
        function loadHistory() {
            const filter = document.getElementById('history-filter').value;
            const tbody = document.getElementById('history-body');
            tbody.innerHTML = '';

            let filteredTransactions = transactions;
            if (filter !== 'all') {
                filteredTransactions = transactions.filter(t => t.decision === filter);
            }

            if (filteredTransactions.length === 0) {
                const row = tbody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 7;
                cell.textContent = 'No transactions found';
                return;
            }

            filteredTransactions.forEach(transaction => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${transaction.tagUID}</td>
                    <td>${transaction.vehicle_type}</td>
                    <td>‚Çπ${transaction.amount}</td>
                    <td class="${transaction.decision}">${transaction.decision.toUpperCase()}</td>
                    <td>${new Date(transaction.timestamp).toLocaleTimeString()}</td>
                    <td>${transaction.reason || '-'}</td>
                    <td>${transaction.ml_scores ? (transaction.ml_scores.modelB_prob * 100).toFixed(1) + '%' : 'N/A'}</td>
                `;
            });
        }

        // Load blockchain data
        function loadBlockchain() {
            const tbody = document.getElementById('blockchain-body');
            tbody.innerHTML = '<tr><td colspan="7">Loading blockchain data...</td></tr>';

            // Try to fetch from backend
            fetch(`${API_BASE}/`) // Health check first
                .then(response => response.json())
                .then(data => {
                    // Backend is available, try to load actual blockchain data
                    // Since we don't have a specific API endpoint for blockchain transactions,
                    // we'll use the existing mock data for now
                    if (blockchainTransactions.length === 0) {
                        // Generate more mock data to represent the blockchain transactions
                        blockchainTransactions = [
                            {
                                transactionId: 0,
                                tagUID: '9C981B6',
                                vehicleType: 'TRUCK',
                                amount: 40000,
                                decision: 'block',
                                reason: 'High fraud probability (RF)',
                                timestamp: Math.floor(Date.now() / 1000) - 300,
                                txHash: '0x4991c993f3f87effecf0d9e503e731765aa662b1b8c2a3d11672c6e85a7cb65f',
                                registeredBy: '0x706C8a20338A3Faa7aB8262e4003A9a344a71d50'
                            },
                            {
                                transactionId: 1,
                                tagUID: '5B88F75',
                                vehicleType: 'CAR',
                                amount: 12000,
                                decision: 'allow',
                                reason: '',
                                timestamp: Math.floor(Date.now() / 1000) - 600,
                                txHash: '0x10785a8e161bf117c21d0c935c45c0f79d8298a009db65d45801c8b534e6589f',
                                registeredBy: '0x706C8a20338A3Faa7aB8262e4003A9a344a71d50'
                            },
                            {
                                transactionId: 2,
                                tagUID: 'BE9E1E33',
                                vehicleType: 'BUS',
                                amount: 25000,
                                decision: 'allow',
                                reason: '',
                                timestamp: Math.floor(Date.now() / 1000) - 900,
                                txHash: '0x2a3b4c5d6e7f8g9h10i11j12k13l14m15n16o17p18q19r20s21t22u23v24w',
                                registeredBy: '0x706C8a20338A3Faa7aB8262e4003A9a344a71d50'
                            },
                            {
                                transactionId: 3,
                                tagUID: '1A2B3C4',
                                vehicleType: 'CAR',
                                amount: 12000,
                                decision: 'block',
                                reason: 'Duplicate scan within 1 minute',
                                timestamp: Math.floor(Date.now() / 1000) - 1200,
                                txHash: '0x3b4c5d6e7f8g9h10i11j12k13l14m15n16o17p18q19r20s21t22u23v24w25x',
                                registeredBy: '0x706C8a20338A3Faa7aB8262e4003A9a344a71d50'
                            },
                            {
                                transactionId: 4,
                                tagUID: '5D6E7F8',
                                vehicleType: 'TRUCK',
                                amount: 40000,
                                decision: 'allow',
                                reason: '',
                                timestamp: Math.floor(Date.now() / 1000) - 1500,
                                txHash: '0x4c5d6e7f8g9h10i11j12k13l14m15n16o17p18q19r20s21t22u23v24w25x26y',
                                registeredBy: '0x706C8a20338A3Faa7aB8262e4003A9a344a71d50'
                            }
                        ];
                    }

                    tbody.innerHTML = '';
                    blockchainTransactions.forEach(tx => {
                        const row = tbody.insertRow();
                        row.innerHTML = `
                            <td>#${tx.transactionId}</td>
                            <td>${tx.tagUID.substring(0, 4)}...${tx.tagUID.substring(tx.tagUID.length - 4)}</td>
                            <td>${tx.vehicleType}</td>
                            <td>${new Date(tx.timestamp * 1000).toLocaleString()}</td>
                            <td class="${tx.decision}">${tx.decision.toUpperCase()}</td>
                        `;
                    });
                })
                .catch(error => {
                    // Backend not available, use mock data
                    console.log('Backend not available, using simulated blockchain data');

                    // Generate more mock data to represent the blockchain transactions
                    blockchainTransactions = [
                        {
                            transactionId: 0,
                            tagUID: '9C981B6',
                            vehicleType: 'TRUCK',
                            amount: 40000,
                            decision: 'block',
                            reason: 'High fraud probability (RF)',
                            timestamp: Math.floor(Date.now() / 1000) - 300,
                            txHash: '0x4991c993f3f87effecf0d9e503e731765aa662b1b8c2a3d11672c6e85a7cb65f',
                            registeredBy: '0x706C8a20338A3Faa7aB8262e4003A9a344a71d50'
                        },
                        {
                            transactionId: 1,
                            tagUID: '5B88F75',
                            vehicleType: 'CAR',
                            amount: 12000,
                            decision: 'allow',
                            reason: '',
                            timestamp: Math.floor(Date.now() / 1000) - 600,
                            txHash: '0x10785a8e161bf117c21d0c935c45c0f79d8298a009db65d45801c8b534e6589f',
                            registeredBy: '0x706C8a20338A3Faa7aB8262e4003A9a344a71d50'
                        },
                        {
                            transactionId: 2,
                            tagUID: 'BE9E1E33',
                            vehicleType: 'BUS',
                            amount: 25000,
                            decision: 'allow',
                            reason: '',
                            timestamp: Math.floor(Date.now() / 1000) - 900,
                            txHash: '0x2a3b4c5d6e7f8g9h10i11j12k13l14m15n16o17p18q19r20s21t22u23v24w',
                            registeredBy: '0x706C8a20338A3Faa7aB8262e4003A9a344a71d50'
                        },
                        {
                            transactionId: 3,
                            tagUID: '1A2B3C4',
                            vehicleType: 'CAR',
                            amount: 12000,
                            decision: 'block',
                            reason: 'Duplicate scan within 1 minute',
                            timestamp: Math.floor(Date.now() / 1000) - 1200,
                            txHash: '0x3b4c5d6e7f8g9h10i11j12k13l14m15n16o17p18q19r20s21t22u23v24w25x',
                            registeredBy: '0x706C8a20338A3Faa7aB8262e4003A9a344a71d50'
                        },
                        {
                            transactionId: 4,
                            tagUID: '5D6E7F8',
                            vehicleType: 'TRUCK',
                            amount: 40000,
                            decision: 'allow',
                            reason: '',
                            timestamp: Math.floor(Date.now() / 1000) - 1500,
                            txHash: '0x4c5d6e7f8g9h10i11j12k13l14m15n16o17p18q19r20s21t22u23v24w25x26y',
                            registeredBy: '0x706C8a20338A3Faa7aB8262e4003A9a344a71d50'
                        }
                    ];

                    tbody.innerHTML = '';
                    blockchainTransactions.forEach(tx => {
                        const row = tbody.insertRow();
                        row.innerHTML = `
                            <td>#${tx.transactionId}</td>
                            <td>${tx.tagUID.substring(0, 4)}...${tx.tagUID.substring(tx.tagUID.length - 4)}</td>
                            <td>${tx.vehicleType}</td>
                            <td>${new Date(tx.timestamp * 1000).toLocaleString()}</td>
                            <td class="${tx.decision}">${tx.decision.toUpperCase()}</td>
                        `;
                    });
                });
        }

        // Initialize the dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboard();
        });

        // Allow Enter key to trigger form submissions
        document.getElementById('process-uid').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') processToll();
        });

        document.getElementById('lookup-uid').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') lookupCard();
        });

        // Sample data buttons for quick testing
        document.getElementById('process-uid').addEventListener('focus', function() {
            this.value = this.value || '9C981B6';
        });

        // Function to manually sync pending events
        function syncPendingEvents() {
            // Call the backend API to sync pending events
            fetch(`${API_BASE}/api/events/sync`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                alert('Sync triggered: ' + data.status);
                // Refresh the status after sync
                setTimeout(() => {
                    loadDashboard();
                }, 1000);
            })
            .catch(error => {
                console.error('Error syncing events:', error);
                alert('Error syncing events');
            });
        }

        // Function to open simulation console in new window
        function openSimulationConsole() {
            window.open('simulation.html', '_blank', 'width=1200,height=800,resizable=yes,scrollbars=yes');
        }

        // Tab switching functionality
        function switchToDashboard() {
            // Show dashboard content, hide others
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById('dashboard').classList.add('active');

            // Update active tab
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            loadDashboard();
        }

        function switchToProcess() {
            // Show process content, hide others
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById('process').classList.add('active');

            // Update active tab
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        function switchToLookup() {
            // Show lookup content, hide others
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById('lookup').classList.add('active');

            // Update active tab
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        function switchToHistory() {
            // Show history content, hide others
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById('history').classList.add('active');

            // Update active tab
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            loadHistory();
        }

        function switchToBlockchain() {
            // Show blockchain content, hide others
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById('blockchain').classList.add('active');

            // Update active tab
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            loadBlockchain();
        }

        function switchToComparison() {
            // Show comparison content, hide others
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById('comparison').classList.add('active');

            // Update active tab
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        function switchToSecurity() {
            // Show security content, hide others
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById('security').classList.add('active');

            // Update active tab
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        function switchToPrivacy() {
            // Show privacy content, hide others
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById('privacy').classList.add('active');

            // Update active tab
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        async function refreshReaderTrust() {
            try {
                const response = await fetch(`${API_BASE}/api/reader/trust/TOLL_READER_01`);
                const data = await response.json();

                if (response.ok) {
                    document.getElementById('current-reader-id').textContent = data.reader_id;
                    document.getElementById('current-trust-score').textContent = data.trust_score;
                    document.getElementById('current-trust-status').textContent = data.trust_status;

                    // Update color based on trust status
                    const statusElement = document.getElementById('current-trust-status');
                    if (data.trust_status === 'TRUSTED') {
                        statusElement.style.color = '#27ae60';
                    } else if (data.trust_status === 'DEGRADED') {
                        statusElement.style.color = '#f39c12';
                    } else if (data.trust_status === 'SUSPENDED') {
                        statusElement.style.color = '#e74c3c';
                    }
                } else {
                    console.error('Failed to fetch reader trust:', data);
                }
            } catch (error) {
                console.error('Error fetching reader trust:', error);
            }
        }

        // Load reader trust info when page loads
        window.onload = function() {
            loadDashboard();
            // Try to load reader trust info
            setTimeout(refreshReaderTrust, 1000); // Delay to allow backend to start
        };
    </script>
</body>
</html>