<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Reader Activity Timeline</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" />
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>

<header>
  <h1>Reader Activity Timeline</h1>
</header>

<nav>
  <a href="index.html">Dashboard</a>
  <a href="readers.html">Reader Trust</a>
  <a href="decisions.html">Decision Telemetry</a>
  <a href="blockchain.html">Blockchain Audit</a>
  <a href="manual-entry.html">Manual Entry</a>
  <a href="admin-trust.html">Admin Control</a>
  <a href="reader-management.html">Reader Management</a>
  <a href="toll-processing.html">Toll Processing</a>
</nav>

<main>
  <div class="container">
    <div class="card">
      <h2>Reader Activity Audit Trail</h2>
      <p>View detailed activity timeline for any reader in the system</p>

      <div class="form-section">
        <h3>View Reader Activity</h3>
        <form id="reader-activity-form">
          <div>
            <label for="reader-id-input">Reader ID:</label>
            <input type="text" id="reader-id-input" placeholder="Enter Reader ID (e.g., RDR-001)" required>
          </div>

          <button type="submit">Load Activity Timeline</button>
        </form>

        <div id="activity-results" style="margin-top: 20px;"></div>
      </div>
    </div>
  </div>
</main>

<script src="js/common.js"></script>
<script>
  // Handle reader activity form submission
  document.getElementById('reader-activity-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    const readerId = document.getElementById('reader-id-input').value.trim();
    const resultsDiv = document.getElementById('activity-results');

    if (!readerId) {
      resultsDiv.innerHTML = `
        <div class="error">
          <h3>‚ùå Error</h3>
          <p>Please enter a Reader ID.</p>
        </div>
      `;
      return;
    }

    try {
      resultsDiv.innerHTML = '<p>Loading activity timeline...</p>';

      const response = await fetch(`${window.API_BASE_URL}/readers/${encodeURIComponent(readerId)}/activity`);

      if (response.ok) {
        const activities = await response.json();

        if (activities.length === 0) {
          resultsDiv.innerHTML = `
            <div class="card">
              <h4>Activity Timeline for ${readerId}</h4>
              <p>No activity found for this reader.</p>
            </div>
          `;
          return;
        }

        let html = `
          <div class="card">
            <h4>Activity Timeline for ${readerId} (${activities.length} events)</h4>
            <div class="activity-list">
        `;

        activities.forEach(activity => {
          html += `
            <div class="activity-item">
              <div class="activity-header">
                <div class="activity-action">${activity.action}</div>
                <div class="activity-timestamp">${formatTimestamp(activity.timestamp)}</div>
              </div>
              <div class="activity-detail">${activity.detail}</div>
            </div>
          `;
        });

        html += `
            </div>
          </div>
        `;

        resultsDiv.innerHTML = html;
      } else {
        resultsDiv.innerHTML = `
          <div class="error">
            <h3>‚ùå Error Loading Timeline</h3>
            <p><strong>Error:</strong> ${response.statusText}</p>
            <p><strong>Status Code:</strong> ${response.status}</p>
          </div>
        `;
      }
    } catch (err) {
      resultsDiv.innerHTML = `
        <div class="error">
          <h3>üåê Network Error</h3>
          <p><strong>Error:</strong> ${err.message}</p>
        </div>
      `;
    }
  });
</script>
</body>
</html>